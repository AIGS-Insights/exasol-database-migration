# Converting a flat table to a star schema

This script will convert a single table to a star schema, no data will be dropped when the script is executed. More details in regards to what is a Star Schema can be found here: [Wiki: Star schema](https://en.wikipedia.org/wiki/Star_schema/)


###### Please be aware this script will only create **one** fact table when executed.

## How to use the script (conditions to be aware of)

1. You will need to create the script in a desired schema.
2. Open the schema where you wish to create your new star schema with the `OPEN SCHEMA` command. This is where the tables will be created and data will be copied into.
3. Supply the script with the correct parameters (example & description below).
4. Execute the script and refresh the database browser window in your chosen IDE. You should see the new tables created.

## Parameters to be aware of

Below is the execute statement for the script with an index for each of the parameters.

```console
EXECUTE SCRIPT CONVERT_TO_STAR_SCHEMA(
	'FLAT_TABLE', 
	'GIVEN_FACT_TABLE_NAME', 
	 DO_CREATE_TABLES, 
	 TRANSFER_DATA, 
	 ARRAY 
		(DIMENSION_TABLE_NAMES), 
	 ARRAY 
		(COL_WITH_INDEX) 
);
```
* **[1st Parameter] `FLAT_TABLE`:** This is the location of flat table which will be parsed into the script. This is case sensitive so if the name of the flat table is case sensitive then insert the characters correctly. There is no need to insert double quotes within the single quotes.

* **[2nd Parameter] `GIVEN_FACT_TABLE_NAME`:** This is the input for the desired name for the fact table, if you do not have a name for the fact table then you can just leave it as the deafult `FACT_TABLE`.

* **[3rd Parameter] `DO_CREATE_TABLES`:** This is a boolean where if set to true then the tables will be physically created, if you wish to view the SQL statements generated by the script then please leave it as `FALSE`. If satisfied with the genereated output and there are no errors, then change the boolean to `TRUE` to have the script execute the statements for you or you can simply copy the statements from the console and execute them individually.

* **[4th Parameter] `TRANSFER_DATA`:** This field also requires a boolean value to copy the data in the flat table to the star schema. If you leave this set to `FALSE` then no data will be copied over, this may be useful if you wish to take a look at the statements created before copying the data. There is no data lost on execution, only replicated.

* **[5th Parameter] `ARRAY (DIMENSION_TABLE_NAMES)`:** This is an array of the desired dimensions, you can have as many as you wish but be aware the columns in the flat table will be allocated to the dimensions you specify.

* **[6th Parameter] `ARRAY (COL_WITH_INDEX)`:** In this array you must provide the list of **only** the columns you wish to map to the dimensions which have been specified in the previous array. The columns which have not been mentioned will be placed in the fact table.

## Example

###### An sql file will be supplied in this repository containing the example below. In this example we will be creating a flat table and populate it with some fake data. Using both the flat table and the script we will then be able to generate the star schema.

#### 1. We will begin by creating a schema for the example:
```console
CREATE SCHEMA EXAMPLE;
```

#### 2. Followed by creating a `FLAT` table:
###### The idea behind this flat table is to have a table containing information about a specific product, details about the supplier and any orders made towards the product.
```console
CREATE OR REPLACE TABLE FLAT (
	PROD_NAME VARCHAR(300),
	PROD_PRICE DECIMAL(19,2),
	PROD_DESC VARCHAR(300),
	SUPP_NAME VARCHAR(300),
	SUPP_ADD VARCHAR(300),
	ORDER_NAME VARCHAR(300),
	ORDER_SIZE DECIMAL(19,2),
	ORDER_DATE DATE,
	ORDER_WEIGHT DECIMAL(19,2)
);
```


#### 3. Run this insert statement which will create 100,000 rows of dummy data into the table:
###### The names of each product have a number appended to them to represent a unique name. The same thing applies to the details of the orders and the suppliers.
```console
INSERT INTO FLAT (
	SELECT 
		'PRODUCTNAME_' || CAST(RAND(1,100) AS DECIMAL(10,0)),
		ROUND(RAND(1, 200), 2),
		'RAND_DESCRIPTION',
		'SUPPLIERNAME_' || CAST(RAND(1,9) AS DECIMAL(10,0)),
		'SUP_ADDRESS',
		'ORDER_NAME_' || CAST(RAND(1,500) AS DECIMAL(10,0)),
		CAST(ROUND(RAND(1, 50), 0) AS DECIMAL(10,0)),
		SYSDATE - ROUND(RAND(1, 365), 0),
		ROUND(RAND(1, 50), 2)
	FROM 
		DUAL 
	CONNECT BY LEVEL <= 100000
);
```

#### 4. Run the execute statement below:
###### In the code below the boolean values have been set to false so we can view the statements before they are executed in the script. In this instance we want to map the column `PROD_NAME` and `PROD_DESC` to the `DIMPRODUCT` table and the `SUPP_NAME` and `SUPP_ADD` to the `DIMSUPPLIER` table. Lastly we will map the `ORDER_NAME` to the `DIMORDER` table. 
###### The only way to map is by typing the position of the dimension table in the array followed by a pipe (`|`) next to the column names. You must make sure the correct column names in the execute statement match the flat table, otherwise the script will fail.
###### Notice the `PROD_PRICE`, `ORDER_SIZE` and `ORDER_DATE` columns are not referenced here, they will be placed in the fact table as here we are only defining the columns for the dimension tables.
```console
EXECUTE SCRIPT CONVERT_TO_STAR_SCHEMA('EXAMPLE.FLAT', 'FACT_TABLE', FALSE, FALSE,

	ARRAY(
		'DIMPRODUCT',
		'DIMSUPPLIER',
		'DIMORDER'
	),
	
	ARRAY(
		'1|PROD_NAME',
		'1|PROD_DESC',
		'2|SUPP_NAME',
		'2|SUPP_ADD',
		'3|ORDER_NAME'
	)
);
```

#### 5. Analyse the statements produced:

###### Below are the create statements and insert statements the script generates. If there are no errors you can execute the script with both booleans set to true.

```console
---CREATE TABLE STATEMENTS---
CREATE OR REPLACE TABLE DIMPRODUCT (DIMPRODUCT_PK DECIMAL(10,0) IDENTITY, "PROD_NAME" VARCHAR(300) UTF8, "PROD_DESC" VARCHAR(300) UTF8, PRIMARY KEY(DIMPRODUCT_PK))
CREATE OR REPLACE TABLE DIMSUPPLIER (DIMSUPPLIER_PK DECIMAL(10,0) IDENTITY, "SUPP_NAME" VARCHAR(300) UTF8, "SUPP_ADD" VARCHAR(300) UTF8, PRIMARY KEY(DIMSUPPLIER_PK))
CREATE OR REPLACE TABLE DIMORDER (DIMORDER_PK DECIMAL(10,0) IDENTITY, "ORDER_NAME" VARCHAR(300) UTF8, PRIMARY KEY(DIMORDER_PK))
CREATE OR REPLACE TABLE FACT_TABLE (DIMPRODUCT_FK DECIMAL(10,0), DIMSUPPLIER_FK DECIMAL(10,0), DIMORDER_FK DECIMAL(10,0), "PROD_PRICE" DECIMAL(19,2), "ORDER_SIZE" DECIMAL(19,2), "ORDER_DATE" DATE, "ORDER_WEIGHT" DECIMAL(19,2), FOREIGN KEY(DIMORDER_FK) REFERENCES DIMORDER(DIMORDER_PK), FOREIGN KEY(DIMSUPPLIER_FK) REFERENCES DIMSUPPLIER(DIMSUPPLIER_PK), FOREIGN KEY(DIMPRODUCT_FK) REFERENCES DIMPRODUCT(DIMPRODUCT_PK))
---INSERT TABLE STATEMENTS---
INSERT INTO DIMPRODUCT("PROD_NAME", "PROD_DESC") (SELECT DISTINCT "PROD_NAME", "PROD_DESC" FROM EXAMPLE."FLAT" WHERE NOT EXISTS (SELECT 1 FROM DIMPRODUCT WHERE (((DIMPRODUCT."PROD_NAME" = "FLAT"."PROD_NAME") OR (DIMPRODUCT."PROD_NAME" IS NULL AND "FLAT"."PROD_NAME" IS NULL)) AND ((DIMPRODUCT."PROD_DESC" = "FLAT"."PROD_DESC") OR (DIMPRODUCT."PROD_DESC" IS NULL AND "FLAT"."PROD_DESC" IS NULL)))))
INSERT INTO DIMSUPPLIER("SUPP_NAME", "SUPP_ADD") (SELECT DISTINCT "SUPP_NAME", "SUPP_ADD" FROM EXAMPLE."FLAT" WHERE NOT EXISTS (SELECT 1 FROM DIMSUPPLIER WHERE (((DIMSUPPLIER."SUPP_NAME" = "FLAT"."SUPP_NAME") OR (DIMSUPPLIER."SUPP_NAME" IS NULL AND "FLAT"."SUPP_NAME" IS NULL)) AND ((DIMSUPPLIER."SUPP_ADD" = "FLAT"."SUPP_ADD") OR (DIMSUPPLIER."SUPP_ADD" IS NULL AND "FLAT"."SUPP_ADD" IS NULL)))))
INSERT INTO DIMORDER("ORDER_NAME") (SELECT DISTINCT "ORDER_NAME" FROM EXAMPLE."FLAT" WHERE NOT EXISTS (SELECT 1 FROM DIMORDER WHERE (((DIMORDER."ORDER_NAME" = "FLAT"."ORDER_NAME") OR (DIMORDER."ORDER_NAME" IS NULL AND "FLAT"."ORDER_NAME" IS NULL)))))
INSERT INTO FACT_TABLE (DIMPRODUCT_FK, DIMSUPPLIER_FK, DIMORDER_FK, "PROD_PRICE", "ORDER_SIZE", "ORDER_DATE", "ORDER_WEIGHT") (SELECT DIMPRODUCT_PK, DIMSUPPLIER_PK, DIMORDER_PK, "FLAT"."PROD_PRICE", "FLAT"."ORDER_SIZE", "FLAT"."ORDER_DATE", "FLAT"."ORDER_WEIGHT" FROM EXAMPLE."FLAT" INNER JOIN DIMPRODUCT ON ((DIMPRODUCT."PROD_NAME" = "FLAT"."PROD_NAME") OR (DIMPRODUCT."PROD_NAME" IS NULL AND "FLAT"."PROD_NAME" IS NULL)) AND ((DIMPRODUCT."PROD_DESC" = "FLAT"."PROD_DESC") OR (DIMPRODUCT."PROD_DESC" IS NULL AND "FLAT"."PROD_DESC" IS NULL)) INNER JOIN DIMSUPPLIER ON ((DIMSUPPLIER."SUPP_NAME" = "FLAT"."SUPP_NAME") OR (DIMSUPPLIER."SUPP_NAME" IS NULL AND "FLAT"."SUPP_NAME" IS NULL)) AND ((DIMSUPPLIER."SUPP_ADD" = "FLAT"."SUPP_ADD") OR (DIMSUPPLIER."SUPP_ADD" IS NULL AND "FLAT"."SUPP_ADD" IS NULL)) INNER JOIN DIMORDER ON ((DIMORDER."ORDER_NAME" = "FLAT"."ORDER_NAME") OR (DIMORDER."ORDER_NAME" IS NULL AND "FLAT"."ORDER_NAME" IS NULL)) WHERE NOT EXISTS (SELECT 1 FROM FACT_TABLE WHERE (((DIMPRODUCT.DIMPRODUCT_PK = FACT_TABLE.DIMPRODUCT_FK) OR (DIMPRODUCT.DIMPRODUCT_PK IS NULL AND FACT_TABLE.DIMPRODUCT_FK IS NULL)) AND ((DIMSUPPLIER.DIMSUPPLIER_PK = FACT_TABLE.DIMSUPPLIER_FK) OR (DIMSUPPLIER.DIMSUPPLIER_PK IS NULL AND FACT_TABLE.DIMSUPPLIER_FK IS NULL)) AND ((DIMORDER.DIMORDER_PK = FACT_TABLE.DIMORDER_FK) OR (DIMORDER.DIMORDER_PK IS NULL AND FACT_TABLE.DIMORDER_FK IS NULL))) AND ((("PROD_PRICE" = "FLAT"."PROD_PRICE") OR ("PROD_PRICE" IS NULL AND "FLAT"."PROD_PRICE" IS NULL)) AND (("ORDER_SIZE" = "FLAT"."ORDER_SIZE") OR ("ORDER_SIZE" IS NULL AND "FLAT"."ORDER_SIZE" IS NULL)) AND (("ORDER_DATE" = "FLAT"."ORDER_DATE") OR ("ORDER_DATE" IS NULL AND "FLAT"."ORDER_DATE" IS NULL)) AND (("ORDER_WEIGHT" = "FLAT"."ORDER_WEIGHT") OR ("ORDER_WEIGHT" IS NULL AND "FLAT"."ORDER_WEIGHT" IS NULL)))))
```

#### 6. Executing the statement with booleans set to true

###### After executing the statement you should see 4 tables created in total in your IDE. You can then do a `SELECT *` on each table and view the ouput. If you do a `count(*)` on the fact table you should see 1000 rows, which is the same number of rows found in the flat table.

```console
EXECUTE SCRIPT CONVERT_TO_STAR_SCHEMA('EXAMPLE.FLAT', 'FACT_TABLE', TRUE, TRUE,

	ARRAY(
		'DIMPRODUCT',
		'DIMSUPPLIER',
		'DIMORDER'
	),
	
	ARRAY(
		'1|PROD_NAME',
		'1|PROD_DESC',
		'2|SUPP_NAME',
		'2|SUPP_ADD',
		'3|ORDER_NAME'
	)
);
```
